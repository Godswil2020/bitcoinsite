<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - User Management</title>
  <style>
    /* Add minimal styles so it looks decent */
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: #f0f0f0;
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    .sidebar div {
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
    }
    .sidebar div.active {
      background-color: #007bff;
      color: white;
    }
    .main {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .user-details {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 600px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    input, select, textarea {
      padding: 0.5rem;
      font-size: 1rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea {
      resize: vertical;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .chat-section {
      border-top: 1px solid #ccc;
      padding-top: 1rem;
      max-width: 600px;
    }
    .chat-messages {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      background: #fafafa;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2>Users</h2>
    <div class="user-list" id="userList">
      <!-- User list injected here -->
    </div>
  </div>

  <div class="main">

    <div class="user-details" id="userDetails" style="display:none;">
      <h3 id="userName">User Name</h3>

      <div class="form-group">
        <label for="fullNameInput">Full Name</label>
        <input type="text" id="fullNameInput" />
      </div>

      <div class="form-group">
        <label for="emailInput">Email (not editable)</label>
        <input type="text" id="emailInput" disabled />
      </div>

      <div class="form-group">
        <label for="joinDateInput">Join Date (not editable)</label>
        <input type="text" id="joinDateInput" disabled />
      </div>

      <div class="form-group">
        <label for="accountStatusSelect">Account Status</label>
        <select id="accountStatusSelect">
          <option>Confirmed</option>
          <option>Pending</option>
          <option>Suspended</option>
          <option>Deactivated</option>
        </select>
      </div>

      <div class="form-group">
        <label for="accountTypeSelect">Account Type</label>
        <select id="accountTypeSelect">
          <option>Basic</option>
          <option>Silver</option>
          <option>Gold</option>
          <option>Premium</option>
        </select>
      </div>

      <div class="form-group">
        <label for="walletBalanceInput">Wallet Balance ($)</label>
        <input type="number" id="walletBalanceInput" min="0" />
      </div>

      <div class="form-group">
        <label for="investedAmountInput">Invested Amount ($)</label>
        <input type="number" id="investedAmountInput" min="0" />
      </div>

      <div class="form-group">
        <label for="totalWithdrawalInput">Total Withdrawal ($)</label>
        <input type="number" id="totalWithdrawalInput" min="0" />
      </div>

      <div class="form-group">
        <label for="referralBonusInput">Referral Bonus ($)</label>
        <input type="number" id="referralBonusInput" min="0" />
      </div>

      <button id="saveUserBtn" disabled>Save User Info</button>

      <div class="chat-section">
        <h4 style="margin-top: 2rem; margin-bottom: 0.5rem;">Chat with User</h4>
        <div class="chat-messages" id="chatMessages"></div>
        <textarea id="chatInput" placeholder="Type a message..."></textarea>
        <button id="sendChatBtn" disabled>Send</button>
      </div>
    </div>

  </div>

  <!-- Firebase Compat Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDqs938UtvScxCz_p2eANLJuVbTjHZKPoI",
    authDomain: "bitcoin-site-8b190.firebaseapp.com",
    projectId: "bitcoin-site-8b190",
    storageBucket: "bitcoin-site-8b190.appspot.com",
    messagingSenderId: "548765450635",
    appId: "1:548765450635:web:3a21f3fefefb117207ef8e",
    measurementId: "G-CMJPS8XHF2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const adminEmail = "profitbitinvestment@outlook.com";

  // Elements
  const userListEl = document.getElementById('userList');
  const userDetailsEl = document.getElementById('userDetails');
  const fullNameInput = document.getElementById('fullNameInput');
  const emailInput = document.getElementById('emailInput');
  const joinDateInput = document.getElementById('joinDateInput');
  const accountStatusSelect = document.getElementById('accountStatusSelect');
  const accountTypeSelect = document.getElementById('accountTypeSelect');
  const walletBalanceInput = document.getElementById('walletBalanceInput');
  const investedAmountInput = document.getElementById('investedAmountInput');
  const totalWithdrawalInput = document.getElementById('totalWithdrawalInput');
  const referralBonusInput = document.getElementById('referralBonusInput');
  const saveUserBtn = document.getElementById('saveUserBtn');

  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  let selectedUser = null;
  let users = []; // Will hold users fetched from Firestore
  let unsubscribeChat = null;

  // Fetch users from Firestore and render
  async function fetchUsers() {
    userListEl.innerHTML = "Loading...";
    try {
      const snapshot = await db.collection("users").get();
      users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderUserList(users);
      // Removed fetchWithdrawalRequests() call here as withdrawals are removed
    } catch (err) {
      userListEl.innerHTML = "Failed to load users.";
      console.error("Error fetching users:", err);
    }
  }

  // Render user list in sidebar
  function renderUserList(users) {
    userListEl.innerHTML = "";
    users.forEach(user => {
      const div = document.createElement("div");
      div.textContent = `${user.fullName} (${user.email})`;
      div.dataset.userid = user.id;
      div.addEventListener("click", () => selectUser(user, div));
      userListEl.appendChild(div);
    });
  }

  // Select a user for editing and chatting
  function selectUser(user, divElement) {
    selectedUser = user;

    Array.from(userListEl.children).forEach(child => child.classList.remove('active'));
    divElement.classList.add('active');

    userDetailsEl.style.display = 'flex';  // SHOW user details

    document.getElementById("userName").textContent = user.fullName || "";
    fullNameInput.value = user.fullName || "";
    emailInput.value = user.email || "";
    joinDateInput.value = user.joinDate || "";
    accountStatusSelect.value = user.accountStatus || "Confirmed";
    accountTypeSelect.value = user.accountType || "Basic";
    walletBalanceInput.value = user.walletBalance ?? 0;
    investedAmountInput.value = user.investedAmount ?? 0;
    totalWithdrawalInput.value = user.totalWithdrawal ?? 0;
    referralBonusInput.value = user.referralBonus ?? 0;

    saveUserBtn.disabled = true;
    sendChatBtn.disabled = false;

    loadChat(user.email);
  }

  // Track input changes to enable save button
  function trackChanges() {
    if (!selectedUser) return;

    const changed =
      fullNameInput.value.trim() !== selectedUser.fullName ||
      accountStatusSelect.value !== selectedUser.accountStatus ||
      accountTypeSelect.value !== selectedUser.accountType ||
      Number(walletBalanceInput.value) !== selectedUser.walletBalance ||
      Number(investedAmountInput.value) !== selectedUser.investedAmount ||
      Number(totalWithdrawalInput.value) !== selectedUser.totalWithdrawal ||
      Number(referralBonusInput.value) !== selectedUser.referralBonus;

    saveUserBtn.disabled = !changed;
  }

  // Save updated user info to Firestore
  saveUserBtn.addEventListener('click', async () => {
    if (!selectedUser) return;

    const updates = {
      fullName: fullNameInput.value.trim(),
      accountStatus: accountStatusSelect.value,
      accountType: accountTypeSelect.value,
      walletBalance: Number(walletBalanceInput.value),
      investedAmount: Number(investedAmountInput.value),
      totalWithdrawal: Number(totalWithdrawalInput.value),
      referralBonus: Number(referralBonusInput.value),
    };

    try {
      await db.collection('users').doc(selectedUser.id).update(updates);
      alert('User information updated successfully!');
      Object.assign(selectedUser, updates);
      fetchUsers();
    } catch (error) {
      alert('Failed to update user info.');
      console.error(error);
    }
  });

  // Listen to inputs to track changes
  [
    fullNameInput,
    accountStatusSelect,
    accountTypeSelect,
    walletBalanceInput,
    investedAmountInput,
    totalWithdrawalInput,
    referralBonusInput
  ].forEach(el => el.addEventListener('input', trackChanges));

  // Load chat messages for a user
  async function loadChat(userEmail) {
    if (unsubscribeChat) unsubscribeChat();

    chatMessages.innerHTML = "Loading...";

    const messageRef = db
      .collection("messages")
      .doc(userEmail)
      .collection("messages")
      .orderBy("timestamp", "asc");

    unsubscribeChat = messageRef.onSnapshot(snapshot => {
      chatMessages.innerHTML = "";

      if (snapshot.empty) {
        chatMessages.textContent = "No messages yet.";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.textContent = `[${data.sender === "admin" ? "Admin" : "User"}] ${data.text}`;
        div.style.background = data.sender === "admin" ? "#d1f7d6" : "#f1f1f1";
        div.style.padding = "0.5rem";
        div.style.marginBottom = "0.3rem";
        div.style.borderRadius = "4px";
        chatMessages.appendChild(div);
      });

      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  // Send chat message
  sendChatBtn.addEventListener('click', async () => {
    if (!selectedUser || !chatInput.value.trim()) return;

    try {
      await db
        .collection("messages")
        .doc(selectedUser.email)
        .collection("messages")
        .add({
          text: chatInput.value.trim(),
          sender: "admin",
          fromEmail: adminEmail,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

      chatInput.value = "";
    } catch (error) {
      console.error("Failed to send message:", error);
    }
  });

  chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendChatBtn.click();
    }
  });

  // Initialize
  window.onload = fetchUsers;
  </script>

</body>
</html>
